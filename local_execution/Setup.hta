<!DOCTYPE html>
<html>
<head>
    <title>CodeSynq Engine Manager</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <HTA:APPLICATION 
        ID="CodeSynqManager" 
        APPLICATIONNAME="CodeSynq Manager" 
        BORDER="dialog"
        BORDERSTYLE="normal" 
        CAPTION="yes" 
        ICON="codesynq.ico" 
        MAXIMIZEBUTTON="no" 
        MINIMIZEBUTTON="yes" 
        SHOWINTASKBAR="yes" 
        SINGLEINSTANCE="yes" 
        SYSMENU="yes" 
        VERSION="2.0" 
        WINDOWSTATE="normal"
        INNERBORDER="no"
        SCROLL="no"
    />
    
    <style>
        * { box-sizing: border-box; user-select: none; cursor: default; }
        
        body {
            background-color: #0f111a;
            color: #e8e8ff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        .header {
            padding: 15px 20px;
            background: linear-gradient(180deg, rgba(30, 32, 48, 0.8) 0%, rgba(15, 17, 26, 0) 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0;
        }
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo { 
            width: 36px; height: 36px; 
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-family: monospace; font-size: 16px;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.4);
        }
        .title h1 { font-size: 16px; margin: 0; font-weight: 600; }
        .title p { font-size: 11px; margin: 2px 0 0 0; color: #8899aa; }
        .status-pill {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            background: rgba(255,255,255,0.1);
            color: #aaa;
            transition: all 0.3s;
        }
        .status-pill.online { background: rgba(76, 175, 80, 0.2); color: #4caf50; border: 1px solid rgba(76, 175, 80, 0.3); }
        .status-pill.offline { background: rgba(255, 71, 87, 0.2); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.3); }

        /* --- Main Content --- */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Cards */
        .card {
            background: #1a1c29;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .card-header { font-size: 13px; font-weight: 700; color: #8899aa; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Service Control - Big Toggle */
        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .service-info h2 { font-size: 18px; margin: 0; margin-bottom: 4px; }
        .service-info p { font-size: 12px; color: #8899aa; margin: 0; }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            cursor: pointer;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            border-radius: 30px;
            transition: .4s;
            border: 2px solid #444;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 2px; bottom: 2px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }
        input:checked + .slider { background-color: #4caf50; border-color: #4caf50; }
        input:checked + .slider:before { transform: translateX(30px); }

        /* Languages Grid - Using Floats for IE compatibility */
        .lang-grid { margin: 0 -5px; overflow: hidden; }
        .lang-item {
            float: left;
            width: 48%;
            margin: 0 1% 10px 1%;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            display: flex; /* Flex works ok for alignment inside box */
            align-items: center;
            justify-content: space-between;
            border: 1px solid transparent;
            min-height: 52px;
            transition: all 0.2s;
        }
        .lang-item:hover { border-color: rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); }
        .lang-left { display: flex; align-items: center; gap: 10px; }
        /* IE11 doesn't support gap in flex, use margin for icon */
        .lang-icon { 
            width: 30px; height: 30px; 
            border-radius: 6px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; color: white;
            margin-right: 10px; flex-shrink: 0;
        }
        .lang-name { font-size: 13px; font-weight: 600; }
        .lang-status { font-size: 10px; color: #8899aa; }
        
        .action-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: #8899aa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
        }
        .action-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .action-btn.install { border-color: #667eea; color: #667eea; }
        .action-btn.install:hover { background: #667eea; color: white; }

        /* Tools - Buttons */
        .tools-grid { margin: 0 -5px; overflow: hidden; }
        .btn {
            float: left;
            width: 48%;
            margin: 0 1% 0 1%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            transition: all 0.2s;
        }
        /* Manually add spacing for icon in flexless environment if needed, but flex inside btn is mostly ok */
        .btn span { margin-right: 6px; } 
        
        .btn-update { background: rgba(102, 126, 234, 0.1); color: #667eea; border: 1px solid rgba(102, 126, 234, 0.3); }
        .btn-update:hover { background: #667eea; color: white; }
        .btn-remove { background: rgba(255, 71, 87, 0.1); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.3); }
        .btn-remove:hover { background: #ff4757; color: white; }

        /* Log Console */
        .console {
            background: #000;
            border-radius: 6px;
            padding: 8px;
            height: 80px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 10px;
            color: #888;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .log-line { margin-bottom: 2px; }
        .log-info { color: #89ddff; }
        .log-success { color: #c3e88d; }
        .log-err { color: #f07178; }

        /* Setup/Modal Overlay */
        .modal-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            align-items: center; justify-content: center;
        }
        .modal {
            background: #1a1c29;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            width: 80%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            color: #e8e8ff;
        }
        .progress-bar {
            height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin: 15px 0;
            overflow: hidden;
        }
        .progress-fill { height: 100%; width: 0%; background: #667eea; transition: width 0.3s; }

        /* Helper colors */
        .icon-js { background: #f0db4f; color: #000; }
        .icon-py { background: #3776ab; }
        .icon-java { background: #f89820; }
        .icon-cpp { background: #00599c; }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="brand">
            <div class="logo">&lt;/&gt;</div>
            <div class="title">
                <h1>CodeSynq Engine</h1>
                <p>Local Execution Environment</p>
            </div>
        </div>
        <div class="status-pill" id="global-status">Checking...</div>
    </div>

    <!-- Content -->
    <div class="content">
        
        <!-- Service Control -->
        <div class="card">
            <div class="card-header">Service Status</div>
            <div class="control-row">
                <div class="service-info">
                    <h2 id="service-title">Stopped</h2>
                    <p id="service-desc">The local engine is not running.</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="service-toggle" onclick="toggleService()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Languages -->
        <div class="card">
            <div class="card-header">Language Support</div>
            <div class="lang-grid">
                <!-- Node.js -->
                <div class="lang-item">
                    <div class="lang-left">
                        <div class="lang-icon icon-js">JS</div>
                        <div>
                            <div class="lang-name">Node.js</div>
                            <div class="lang-status" id="status-node">Checking...</div>
                        </div>
                    </div>
                </div>

                <!-- Python -->
                <div class="lang-item">
                    <div class="lang-left">
                        <div class="lang-icon icon-py">Py</div>
                        <div>
                            <div class="lang-name">Python</div>
                            <div class="lang-status" id="status-python">Checking...</div>
                        </div>
                    </div>
                    <button class="action-btn" id="btn-python" onclick="installPython()">Install</button>
                </div>

                <!-- Java -->
                <div class="lang-item">
                    <div class="lang-left">
                        <div class="lang-icon icon-java">Jv</div>
                        <div>
                            <div class="lang-name">Java</div>
                            <div class="lang-status" id="status-java">Checking...</div>
                        </div>
                    </div>
                    <button class="action-btn" id="btn-java" onclick="installJava()">Install</button>
                </div>

                <!-- C++ -->
                <div class="lang-item">
                    <div class="lang-left">
                        <div class="lang-icon icon-cpp">C++</div>
                        <div>
                            <div class="lang-name">C/C++</div>
                            <div class="lang-status" id="status-cpp">Checking...</div>
                        </div>
                    </div>
                    <!-- C++ usually requires complex setup (Mingw), keeping basic check for now or link to guide? 
                         We'll stick to basic check/placeholder for this simplified UI -->
                     <button class="action-btn" id="btn-cpp" style="display:none">Info</button>
                </div>
            </div>
        </div>

        <!-- Tools -->
        <div class="card">
            <div class="card-header">Tools</div>
            <div class="tools-grid">
                <button class="btn btn-update" onclick="installService()" style="background: rgba(76, 175, 80, 0.1); color: #4caf50; border-color: rgba(76, 175, 80, 0.3);">
                    &#128229; Install / Setup
                </button>
                <button class="btn btn-update" onclick="updateEngine()">
                    &#8635; Check for Updates
                </button>
            </div>
            <div class="tools-grid" style="margin-top: 10px;">
                <button class="btn btn-remove" onclick="confirmUninstall()">
                    &#128465; Uninstall Service
                </button>
            </div>
        </div>

        <!-- Log -->
        <div class="console" id="console">
            <div class="log-line">Initializing CodeSynq Manager...</div>
        </div>

    </div>

    <!-- Modal for Progress/Confirm -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h3 id="modal-title">Processing</h3>
            <p id="modal-desc" style="color:#8899aa; font-size:12px; margin:10px 0;">Please wait...</p>
            <div class="progress-bar"><div class="progress-fill" id="modal-progress"></div></div>
            <div id="modal-actions" style="margin-top:15px; display:none;">
                <button class="btn btn-remove" onclick="closeModal()">Cancel</button>
                <button class="btn btn-update" onclick="performUninstall()">Confirm</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // --- Init & Globals ---
        var shell = new ActiveXObject("WScript.Shell");
        var fso = new ActiveXObject("Scripting.FileSystemObject");
        var isServiceRunning = false;
        var isStarting = false;
        var checkInterval = null;

        // Resize window on load
        window.resizeTo(500, 750);
        window.moveTo((screen.availWidth - 500) / 2, (screen.availHeight - 750) / 2);

        // Start checking
        setTimeout(init, 500);

        function init() {
            log("Checking system environment...");
            checkLanguages();
            checkServiceStatus();
            checkInterval = setInterval(checkServiceStatus, 2000);
        }

        function log(msg, type) {
            var c = document.getElementById('console');
            var d = document.createElement('div');
            d.className = 'log-line ' + (type ? 'log-' + type : 'log-info');
            var time = new Date().toLocaleTimeString().split(' ')[0];
            d.innerText = "[" + time + "] " + msg;
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }

        // --- Service Control ---
        function checkServiceStatus() {
            // If we are intentionally starting, don't let the background poller force us Offline
            if (isStarting) return; 

            var wasRunning = isServiceRunning;
            
            try {
                // Use ServerXMLHTTP for better localhost support in HTA
                var xhr = new ActiveXObject("MSXML2.ServerXMLHTTP.6.0");
                xhr.setTimeouts(1000, 1000, 1000, 1000); // resolve, connect, send, receive
                xhr.open("GET", "http://127.0.0.1:3001/health", false); // Synchronous
                xhr.send();
                
                if (xhr.status == 200) {
                    isServiceRunning = true;
                } else {
                    isServiceRunning = false;
                }
            } catch(e) {
                // Connection refused or timeout - service is not running
                isServiceRunning = false;
            }
            
            updateServiceUI();
            
            if (!wasRunning && isServiceRunning) log("Service detected: ONLINE", "success");
            if (wasRunning && !isServiceRunning) log("Service status: OFFLINE", "err");
        }

        function updateServiceUI() {
            var pill = document.getElementById('global-status');
            var toggle = document.getElementById('service-toggle');
            var title = document.getElementById('service-title');
            var desc = document.getElementById('service-desc');

            if (isStarting) {
                pill.className = 'status-pill online'; // Reuse online style (green/yellow logic below) or keep generic
                pill.style.borderColor = '#ffa502';
                pill.style.color = '#ffa502';
                pill.style.backgroundColor = 'rgba(255, 165, 2, 0.2)';
                pill.innerText = 'STARTING...';
                toggle.checked = true; // Keep visual toggle ON
                title.innerText = 'Starting...';
                desc.innerText = 'Booting up local engine';
                title.style.color = '#ffa502';
                return;
            }

            // Reset manual styles
            pill.style.borderColor = ''; pill.style.color = ''; pill.style.backgroundColor = '';

            if (isServiceRunning) {
                pill.className = 'status-pill online';
                pill.innerText = 'ONLINE';
                toggle.checked = true;
                title.innerText = 'Running';
                title.style.color = '#4caf50';
                desc.innerText = 'Listening on Port 3001';
            } else {
                pill.className = 'status-pill offline';
                pill.innerText = 'OFFLINE';
                toggle.checked = false;
                title.innerText = 'Stopped';
                title.style.color = '#e8e8ff';
                desc.innerText = 'Service is not running';
            }
        }

        function toggleService() {
            var toggle = document.getElementById('service-toggle');
            
            if (toggle.checked) {
                // Turn ON
                if (isStarting || isServiceRunning) return; // Debounce
                
                isStarting = true;
                isServiceRunning = false; // Assume off until verified
                updateServiceUI();
                log("Initiating startup sequence...", "info");

                try {
                    var appData = shell.ExpandEnvironmentStrings("%LOCALAPPDATA%");
                    var installedDir = appData + "\\CodeSynq\\LocalExecution";
                    var startScript = installedDir + "\\start-silent.vbs";

                    // Get HTA's own directory for dev mode
                    var htaPath = unescape(document.location.pathname);
                    if (htaPath.charAt(0) === '/') htaPath = htaPath.substr(1);
                    htaPath = htaPath.replace(/\//g, '\\');
                    var htaDir = htaPath.substring(0, htaPath.lastIndexOf('\\') + 1);

                    var serverPath, workingDir;

                    if (fso.FileExists(startScript)) {
                        // Use installed silent script
                        log("Running installed service...", "info");
                        shell.Run("wscript.exe \"" + startScript + "\"", 0, false);
                    } else if (fso.FileExists(htaDir + "local-server.js")) {
                        // Dev mode: Create a temporary VBS launcher to run silently
                        log("Starting in Dev Mode (Silent)...", "info");
                        
                        serverPath = htaDir + "local-server.js";
                        workingDir = htaDir;
                        
                        // Create temp VBS file for silent launch
                        var tempVbs = shell.ExpandEnvironmentStrings("%TEMP%") + "\\codesynq_start.vbs";
                        var vbsContent = 
                            'Set WshShell = CreateObject("WScript.Shell")\r\n' +
                            'WshShell.CurrentDirectory = "' + workingDir.replace(/\\/g, '\\\\') + '"\r\n' +
                            'WshShell.Run "node """ & "' + serverPath.replace(/\\/g, '\\\\') + '" & """", 0, False\r\n' +
                            'Set WshShell = Nothing\r\n';
                        
                        var vbsFile = fso.CreateTextFile(tempVbs, true);
                        vbsFile.Write(vbsContent);
                        vbsFile.Close();
                        
                        // Run the VBS silently
                        shell.Run("wscript.exe \"" + tempVbs + "\"", 0, false);
                        
                        log("Server launched silently.", "info");
                    } else {
                        log("local-server.js not found!", "err");
                        isStarting = false;
                        toggle.checked = false;
                        updateServiceUI();
                        return;
                    }

                    // Start polling for up to 15 seconds
                    waitForService(0);

                } catch(e) {
                    log("Startup failed: " + e.message, "err");
                    isStarting = false;
                    toggle.checked = false;
                    updateServiceUI();
                }
            } else {
                // Turn OFF (silently)
                log("Stopping service...", "info");
                isStarting = false; // Cancel startup if active
                try {
                    // Run taskkill hidden (0 = hidden window)
                    shell.Run("cmd.exe /c taskkill /F /IM node.exe", 0, true);
                    log("Service stopped.", "success");
                    isServiceRunning = false;
                    updateServiceUI();
                } catch(e) {
                    log("Stop error: " + e.message, "err");
                }
            }
        }

        function waitForService(attempt) {
            if (!isStarting) return; // User cancelled
            if (attempt > 15) {
                log("Startup timed out. Please check console.", "err");
                isStarting = false;
                isServiceRunning = false;
                updateServiceUI();
                return;
            }

            log("Checking service... (attempt " + (attempt + 1) + ")", "info");

            try {
                var xhr = new ActiveXObject("MSXML2.ServerXMLHTTP.6.0");
                xhr.setTimeouts(1000, 1000, 1000, 1000);
                xhr.open("GET", "http://127.0.0.1:3001/health", false); // Synchronous
                xhr.send();
                
                if (xhr.status == 200) {
                    // Success!
                    log("Service is now ONLINE!", "success");
                    isStarting = false;
                    isServiceRunning = true;
                    updateServiceUI();
                    return;
                }
            } catch(e) {
                // Connection refused - service not ready yet
            }
            
            // Not ready yet, try again
            setTimeout(function() { waitForService(attempt + 1); }, 1000);
        }


        // --- Languages ---
        function checkLanguages() {
            // Node
            var r = runCommand("node -v");
            if (r.indexOf("v") >= 0) {
                document.getElementById('status-node').innerText = r.trim();
                document.getElementById('status-node').style.color = '#4caf50';
            } else {
                document.getElementById('status-node').innerText = 'Not Found';
                document.getElementById('status-node').style.color = '#ff4757';
            }

            // Python
            r = runCommand("python --version");
            if (r.indexOf("Python") >= 0) {
                document.getElementById('status-python').innerText = "Installed";
                document.getElementById('status-python').style.color = 'var(--success)';
                document.getElementById('btn-python').style.display = 'none';
            } else {
                document.getElementById('status-python').innerText = 'Not Found';
            }

            // Java
            r = runCommand("java -version 2>&1"); // redirect stderr
            if (r.indexOf("version") >= 0) {
                document.getElementById('status-java').innerText = "Installed";
                document.getElementById('status-java').style.color = 'var(--success)';
                document.getElementById('btn-java').style.display = 'none';
            } else {
                document.getElementById('status-java').innerText = 'Not Found';
            }

            // C++ check
            r = runCommand("g++ --version");
            if (r.indexOf("Free Software Foundation") >= 0 || r.indexOf("Copyright") >= 0) {
                document.getElementById('status-cpp').innerText = "Installed";
                document.getElementById('status-cpp').style.color = 'var(--success)';
            } else {
                document.getElementById('status-cpp').innerText = 'Not Found';
            }
        }

        function runCommand(cmd) {
            try {
                var exec = shell.Exec("cmd.exe /c " + cmd);
                var out = "";
                // Read wait
                while (exec.Status == 0) {
                   if (!exec.StdOut.AtEndOfStream) out += exec.StdOut.ReadAll();
                   if (!exec.StdErr.AtEndOfStream) out += exec.StdErr.ReadAll();
                   // Avoid infinite hang?
                }
                // Final read
                if (!exec.StdOut.AtEndOfStream) out += exec.StdOut.ReadAll();
                if (!exec.StdErr.AtEndOfStream) out += exec.StdErr.ReadAll();
                return out;
            } catch (e) { return ""; }
        }
        
        // --- Utilities ---
        function updateEngine() {
            if (!isServiceRunning) {
                alert("Please start the service first to check for updates!");
                return;
            }
            log("Sending update request...", "info");
            var xhr = new ActiveXObject("MSXML2.XMLHTTP");
            xhr.open("POST", "http://localhost:3001/update", true);
            xhr.send();
            alert("Update command sent. The service will restart momentarily.");
        }

        function installPython() {
            showModal("Downloading Python...", 0);
            // Non-blocking download logic would be complex in HTA without standard fetch
            // Using a simple powershell trigger
            log("Launching Python installer...", "info");
            shell.Run("powershell -Command \"Start-Process 'https://www.python.org/downloads/'\"", 0, false);
            closeModal();
        }

        function installJava() {
            log("Opening OpenJDK download...", "info");
            shell.Run("powershell -Command \"Start-Process 'https://adoptium.net/'\"", 0, false);
        }

        function installService() {
            log("Starting installation...", "info");
            showModal("Installing CodeSynq...", 10);
            
            try {
                // Get paths
                var htaPath = unescape(document.location.pathname);
                if (htaPath.charAt(0) === '/') htaPath = htaPath.substr(1);
                htaPath = htaPath.replace(/\//g, '\\');
                var sourceDir = htaPath.substring(0, htaPath.lastIndexOf('\\') + 1);
                
                var appData = shell.ExpandEnvironmentStrings("%LOCALAPPDATA%");
                var targetDir = appData + "\\CodeSynq\\LocalExecution";
                var codeSynqDir = appData + "\\CodeSynq";
                var desktop = shell.SpecialFolders("Desktop");
                var sysRoot = shell.ExpandEnvironmentStrings("%SystemRoot%");
                
                // Step 1: Create directories
                log("Creating directories...", "info");
                document.getElementById('modal-progress').style.width = "20%";
                
                if (!fso.FolderExists(codeSynqDir)) fso.CreateFolder(codeSynqDir);
                if (!fso.FolderExists(targetDir)) fso.CreateFolder(targetDir);
                
                // Step 2: Copy files
                log("Copying files...", "info");
                document.getElementById('modal-progress').style.width = "40%";
                
                shell.Run("cmd.exe /c xcopy /Y /E /I \"" + sourceDir + "*.*\" \"" + targetDir + "\\\"", 0, true);
                
                // Step 3: Create start-silent.vbs
                log("Creating silent launcher...", "info");
                document.getElementById('modal-progress').style.width = "50%";
                
                var vbsPath = targetDir + "\\start-silent.vbs";
                var vbsContent = 
                    'Set WshShell = CreateObject("WScript.Shell")\r\n' +
                    'WshShell.CurrentDirectory = "' + targetDir.replace(/\\/g, '\\\\') + '"\r\n' +
                    'WshShell.Run "node """ & "' + targetDir.replace(/\\/g, '\\\\') + '\\\\local-server.js" & """", 0, False\r\n' +
                    'Set WshShell = Nothing\r\n';
                var vbsFile = fso.CreateTextFile(vbsPath, true);
                vbsFile.Write(vbsContent);
                vbsFile.Close();
                
                // Step 4: Create desktop shortcuts
                log("Creating desktop shortcuts...", "info");
                document.getElementById('modal-progress').style.width = "70%";
                
                // Use the copied icon from installation directory (with index 0)
                var iconPath = targetDir + "\\codesynq.ico,0";
                
                // Service Manager shortcut
                var sc1 = shell.CreateShortcut(desktop + "\\CodeSynq Service Manager.lnk");
                sc1.TargetPath = "mshta.exe";
                sc1.Arguments = "\"" + targetDir + "\\Setup.hta\"";
                sc1.WorkingDirectory = targetDir;
                sc1.IconLocation = iconPath;
                sc1.Description = "Manage CodeSynq Local Execution Service";
                sc1.Save();
                log("Created: CodeSynq Service Manager.lnk", "success");
                
                // Execution Panel shortcut
                if (fso.FileExists(targetDir + "\\ExecutionPanel.hta")) {
                    var sc2 = shell.CreateShortcut(desktop + "\\CodeSynq Execution Panel.lnk");
                    sc2.TargetPath = "mshta.exe";
                    sc2.Arguments = "\"" + targetDir + "\\ExecutionPanel.hta\"";
                    sc2.WorkingDirectory = targetDir;
                    sc2.IconLocation = iconPath;
                    sc2.Description = "View CodeSynq Execution History";
                    sc2.Save();
                    log("Created: CodeSynq Execution Panel.lnk", "success");
                }
                
                // Step 5: Register startup
                log("Registering Windows startup...", "info");
                document.getElementById('modal-progress').style.width = "90%";
                
                shell.Run("cmd.exe /c reg add \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" /v \"CodeSynqLocal\" /t REG_SZ /d \"wscript.exe \\\"" + vbsPath + "\\\"\" /f", 0, true);
                
                // Done
                document.getElementById('modal-progress').style.width = "100%";
                document.getElementById('modal-desc').innerText = "Installation complete!";
                log("Installation complete! Shortcuts created on desktop.", "success");
                
                setTimeout(function() {
                    closeModal();
                    alert("Installation successful!\\n\\n✓ Desktop shortcuts created\\n✓ Files installed to AppData\\n✓ Registered to start with Windows\\n\\nUse the toggle switch above to start the service.");
                }, 1000);
                
            } catch(e) {
                log("Installation error: " + e.message, "err");
                document.getElementById('modal-desc').innerText = "Error: " + e.message;
            }
        }

        function confirmUninstall() {
            var m = document.getElementById('modal-overlay');
            m.style.display = 'flex';
            document.getElementById('modal-title').innerText = "Uninstall Service?";
            document.getElementById('modal-desc').innerText = "This will stop the service and remove local files.";
            document.getElementById('modal-progress').style.width = "0%";
            document.getElementById('modal-actions').style.display = 'block';
        }
        
        function performUninstall() {
            document.getElementById('modal-actions').style.display = 'none';
            document.getElementById('modal-desc').innerText = "Removing...";
            
            setTimeout(function() {
                log("Stoping service...", "info");
                runCommand("taskkill /F /IM node.exe");
                document.getElementById('modal-progress').style.width = "50%";
                
                setTimeout(function() {
                    log("Cleaning files...", "info");
                    // In a real scenario we'd do full cleanup. For now, just stop.
                    // We can't delete ourself while running easily.
                    // Just removing startup reg key
                    try {
                        shell.Run("reg delete \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" /v \"CodeSynqLocal\" /f", 0, true);
                    } catch(e) {}

                    document.getElementById('modal-progress').style.width = "100%";
                    document.getElementById('modal-desc').innerText = "Service removed from startup. Close window to finish.";
                }, 1000);
            }, 500);
        }

        function showModal(text, progress) {
            var m = document.getElementById('modal-overlay');
            m.style.display = 'flex';
            document.getElementById('modal-title').innerText = "Processing";
            document.getElementById('modal-desc').innerText = text;
            document.getElementById('modal-progress').style.width = progress + "%";
            document.getElementById('modal-actions').style.display = 'none';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

    </script>
</body>
</html>
