<!DOCTYPE html>
<html>

<head>
    <title>CodeSynq - Professional Collaborative Coding</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Monaco Editor will be loaded dynamically -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="nexusstyle.css">
    <link rel="stylesheet" href="modules/share-styles.css">
    <link rel="stylesheet" href="quickopen.css">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    <script src="modules/fullscreen-manager.js"></script>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">
                <i class="fas fa-code"></i>
                <span class="loading-brand">CodeSynq</span>
            </div>
            <div class="loading-animation">
                <div class="loading-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
            <div class="loading-text">Loading your workspace...</div>
            <div class="loading-progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <div class="ide-container">
        <!-- Title Bar -->
        <div class="title-bar">
            <div class="title-bar-left">
                <div class="app-icon"><i class="fas fa-code" style="color: var(--accent-primary);"></i></div>
                <div class="menu-bar">
                    <div class="menu-wrapper">
                        <div class="menu-item" data-menu="file-menu">File</div>
                        <div id="file-menu" class="dropdown-menu top-menu-dropdown">
                            <div class="menu-option" onclick="addNewTab()">New File <span class="shortcut">Ctrl+N</span>
                            </div>
                            <div class="menu-option" onclick="document.getElementById('saveFolderBtn').click()">Open
                                Folder...</div>
                            <div class="menu-separator"></div>
                            <div class="menu-option" onclick="saveCode()">Save <span class="shortcut">Ctrl+S</span>
                            </div>
                            <div class="menu-option">Save As...</div>
                            <div class="menu-separator"></div>
                            <div class="menu-option" onclick="closeTab(activeTabIndex)">Close Editor <span
                                    class="shortcut">Ctrl+W</span></div>
                        </div>
                    </div>
                    <div class="menu-wrapper">
                        <div class="menu-item" data-menu="edit-menu">Edit</div>
                        <div id="edit-menu" class="dropdown-menu top-menu-dropdown">
                            <div class="menu-option" onclick="editor.trigger('keyboard', 'undo')">Undo <span
                                    class="shortcut">Ctrl+Z</span></div>
                            <div class="menu-option" onclick="editor.trigger('keyboard', 'redo')">Redo <span
                                    class="shortcut">Ctrl+Y</span></div>
                            <div class="menu-separator"></div>
                            <div class="menu-option" onclick="editor.focus(); document.execCommand('cut')">Cut <span
                                    class="shortcut">Ctrl+X</span></div>
                            <div class="menu-option" onclick="editor.focus(); document.execCommand('copy')">Copy <span
                                    class="shortcut">Ctrl+C</span></div>
                            <div class="menu-option" onclick="editor.focus(); document.execCommand('paste')">Paste <span
                                    class="shortcut">Ctrl+V</span></div>
                        </div>
                    </div>
                    <div class="menu-wrapper">
                        <div class="menu-item" data-menu="view-menu">View</div>
                        <div id="view-menu" class="dropdown-menu top-menu-dropdown">
                            <div class="menu-option" onclick="document.getElementById('explorer-btn').click()">Explorer
                            </div>
                            <div class="menu-option" onclick="document.getElementById('search-btn').click()">Search
                            </div>
                            <div class="menu-option" onclick="document.getElementById('chat-btn').click()">Chat</div>
                            <div class="menu-separator"></div>
                            <div class="menu-option" onclick="toggleLivePreview()">Toggle Live Preview</div>
                        </div>
                    </div>
                    <div class="menu-wrapper">
                        <div class="menu-item" data-menu="go-menu">Go</div>
                        <div id="go-menu" class="dropdown-menu top-menu-dropdown">
                            <div class="menu-option">Back</div>
                            <div class="menu-option">Forward</div>
                            <div class="menu-separator"></div>
                            <div class="menu-option"
                                onclick="editor.trigger('keyboard', 'editor.action.goToDeclaration')">Go to Definition
                            </div>
                        </div>
                    </div>
                    <div class="menu-wrapper">
                        <div class="menu-item" data-menu="run-menu">Run</div>
                        <div id="run-menu" class="dropdown-menu top-menu-dropdown">
                            <div class="menu-option" onclick="document.getElementById('runCode').click()">Start
                                Debugging <span class="shortcut">F5</span></div>
                            <div class="menu-option" onclick="runCodeLocally()">Run Without Debugging <span
                                    class="shortcut">Ctrl+F5</span></div>
                        </div>
                    </div>
                    <div class="menu-wrapper">
                        <div class="menu-item" data-menu="terminal-menu">Terminal</div>
                        <div id="terminal-menu" class="dropdown-menu top-menu-dropdown">
                            <div class="menu-option" onclick="initTerminal()">New Terminal</div>
                            <div class="menu-option" onclick="clearTerminal()">Clear Terminal</div>
                        </div>
                    </div>
                    <div class="menu-wrapper">
                        <div class="menu-item" data-menu="help-menu">Help</div>
                        <div id="help-menu" class="dropdown-menu top-menu-dropdown">
                            <div class="menu-option" onclick="showNotification('Welcome to CodeSynq!')">Welcome</div>
                            <div class="menu-option"
                                onclick="window.open('https://github.com/monaco-editor/monaco-editor', '_blank')">
                                Documentation</div>
                            <div class="menu-separator"></div>
                            <div class="menu-option"
                                onclick="showCustomPopup('About CodeSynq', 'CodeSynq v1.0.0\nBased on VS Code architecture.')">
                                About</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="title-bar-center">
                <div class="command-palette-trigger">
                    <i class="fas fa-search search-icon"></i>
                    <span>CodeSynq</span>
                    <div class="shortcut-badge">Ctrl+P</div>
                </div>
            </div>
            <div class="title-bar-right">
                <button id="runCode" class="title-bar-btn" title="Run(F5)"><i class="fas fa-play"
                        style="color: var(--success);"></i></button>

                <div class="layout-dropdown" style="position: relative;">
                    <button id="layoutBtn" class="title-bar-btn" title="Change Layout"><i
                            class="fas fa-th-large"></i></button>
                    <div id="layoutMenu" class="dropdown-menu layout-menu">
                        <div class="layout-option" data-layout="50-50"><span>Half-Half</span></div>
                        <div class="layout-option" data-layout="60-40"><span>Editor Focus</span></div>
                        <div class="layout-option" data-layout="70-30"><span>Code Heavy</span></div>
                        <div class="layout-option" data-layout="40-60"><span>Terminal Focus</span></div>
                    </div>
                </div>

                <div class="theme-dropdown" style="position: relative;">
                    <button id="themeToggle" class="title-bar-btn" title="Theme"><i class="fas fa-palette"></i></button>
                    <div id="themeMenu" class="dropdown-menu theme-menu">
                        <div class="theme-option" data-theme="dark">
                            <div class="theme-preview dark"></div><span>Dark Theme</span>
                        </div>
                        <div class="theme-option" data-theme="light">
                            <div class="theme-preview light"></div><span>Light Theme</span>
                        </div>
                        <div class="theme-option" data-theme="blue">
                            <div class="theme-preview blue"></div><span>Blue Theme</span>
                        </div>
                        <div class="theme-option" data-theme="green">
                            <div class="theme-preview green"></div><span>Green Theme</span>
                        </div>
                    </div>
                </div>

                <!-- Login/Signup -->
                <button id="loginBtn" class="btn-primary" style="display: none;">Login</button>
                <button id="signupBtn" class="btn-secondary" style="display: none;">Sign Up</button>

                <!-- Profile -->
                <div class="profile-dropdown" style="position: relative;">
                    <button id="profileBtn" class="title-bar-btn">
                        <i class="fas fa-user"></i>
                        <img id="profileBtnImage" src=""
                            style="display: none; position: absolute; inset:0; border-radius: 50%;">
                    </button>
                    <div id="profileMenu" class="dropdown-menu profile-menu">
                        <div class="profile-info">
                            <div id="profilePictureContainer" style="display:none;"><img id="profilePicture" src="">
                            </div>
                            <span id="profileName">User</span>
                            <span id="profileEmail">email</span>
                            <span id="profileUsername">@user</span>
                        </div>
                        <button id="uploadProfilePicBtn">Change Pic</button>
                        <input type="file" id="profilePictureInput" style="display: none;">
                        <button id="removeProfilePicBtn" style="display: none;">Remove Pic</button>
                        <button id="changeUsernameBtn">Change Username</button>
                        <button onclick="signOut()">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Activity Bar -->
            <!-- Activity Bar -->
            <div class="activity-bar">
                <div class="activity-icons-top">
                    <div class="activity-btn active" id="explorerBtn" title="Explorer" data-view="explorer"><i
                            class="fas fa-copy"></i></div>
                    <div class="activity-btn" title="Search"><i class="fas fa-search"></i></div>
                    <div class="activity-btn" id="friendsBtn" title="Chat" data-view="chat"><i
                            class="fas fa-comment-dots"></i>
                    </div>

                    <div class="notifications-dropdown" style="width: 100%;">
                        <div class="activity-btn" id="notificationsBtn" title="Notifications">
                            <i class="fas fa-bell"></i>
                            <span id="notificationBadge" class="badge" style="display: none;">0</span>
                        </div>
                        <div id="notificationsMenu" class="dropdown-menu notifications-menu"
                            style="left: 48px; top: 0;">
                            <div class="notifications-section">
                                <h4>Community</h4>
                                <div id="friendRequestsSection">
                                    <div id="friendRequestsList" class="friend-requests-list">
                                        <p class="no-requests">No new requests</p>
                                    </div>
                                </div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="notifications-section">
                                <h4>Inbox</h4><button id="openInboxBtn" class="btn-secondary"
                                    onclick="codeShareManager.openReceivedModal()">View Received Codes</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="activity-icons-bottom">
                    <div class="settings-dropdown" style="width: 100%;">
                        <div class="activity-btn" id="settingsBtn" title="Settings"><i class="fas fa-cog"></i></div>
                        <div id="settingsMenu" class="dropdown-menu settings-menu" style="left: 48px; bottom: 0;">
                            <div class="settings-section">
                                <h4>Editor</h4>
                                <div class="setting-item"><label>Font:</label><select id="fontSizeSelect">
                                        <option value="12">12</option>
                                        <option value="14" selected>14</option>
                                        <option value="16">16</option>
                                    </select></div><label><input type="checkbox" id="lineWrapToggle" checked>
                                    Wrap</label><label><input type="checkbox" id="autoCompleteToggle" checked>
                                    Auto</label>
                            </div>
                            <div class="settings-section">
                                <h4>Display</h4><label><input type="checkbox" id="minimapToggle">
                                    Minimap</label><label><input type="checkbox" id="lineNumbersToggle" checked> Line
                                    Nums</label>
                            </div>
                            <div class="settings-section">
                                <h4>UI Design</h4>
                                <div id="basicModeBtn" class="setting-item"
                                    style="cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 8px 0; transition: background 0.2s;">
                                    <i class="fas fa-columns" style="color: #9cafb5;"></i>
                                    <div style="display: flex; flex-direction: column;">
                                        <span style="font-weight: 500;">Basic Mode</span>
                                        <span style="font-size: 11px; color: var(--text-secondary);">Simple Classic
                                            Layout</span>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-section">
                                <h4>Execution</h4>
                                <div class="setting-item" style="margin-bottom: 8px;">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-microchip" style="color: #4ec9b0;"></i>
                                        Mode:
                                    </label>
                                    <select id="executionModeSelect" style="flex: 1; margin-left: 8px;">
                                        <option value="auto">Auto (Local if available)</option>
                                        <option value="local">Local Only</option>
                                        <option value="remote">Remote Only</option>
                                    </select>
                                </div>
                                <div id="localServiceStatus" class="setting-item"
                                    style="display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 12px;">
                                    <span id="localServiceIndicator"
                                        style="width: 8px; height: 8px; border-radius: 50%; background: #f14c4c;"></span>
                                    <span id="localServiceText">Local Service: Checking...</span>
                                </div>
                                <div id="setupLocalServiceBtn" class="setting-item"
                                    style="cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 8px 0; transition: background 0.2s;"
                                    onclick="if(window.executionManager) window.executionManager.showLocalServiceSetup();">
                                    <i class="fas fa-download" style="color: #569cd6;"></i>
                                    <div style="display: flex; flex-direction: column;">
                                        <span style="font-weight: 500;">Setup Local Service</span>
                                        <span style="font-size: 11px; color: var(--text-secondary);">Run code on your
                                            device</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Explorer View -->
                <div id="explorerView" class="sidebar-view active">
                    <div class="sidebar-header"><span class="sidebar-title">EXPLORER</span></div>
                    <div class="file-tree">
                        <div class="workspace-header" style="display: flex; align-items: center;">
                            <i class="fas fa-chevron-down tree-chevron"></i>
                            <span style="flex: 1;">CodeSynq</span>
                            <div class="workspace-actions" style="display: flex; gap: 4px;">
                                <button class="icon-btn-small" id="newFileBtn" title="New File" onclick="addNewTab()"><i
                                        class="fas fa-plus" style="font-size: 12px;"></i></button>
                                <button class="icon-btn-small" id="refreshExplorerBtn" title="Refresh"
                                    onclick="refreshExplorer()"><i class="fas fa-sync-alt"
                                        style="font-size: 12px;"></i></button>
                            </div>
                        </div>
                        <div class="tree-item" id="tempFilesFolder"><i class="fas fa-folder-open folder-icon"></i> <span
                                class="tree-item-name">Temp Files</span></div>
                        <div id="tempFilesList" class="file-list" style="padding-left: 20px; display: block;"></div>

                        <div class="tree-item" id="savedCodesFolder"><i class="fas fa-cloud folder-icon"
                                style="color: #007acc;"></i> <span class="tree-item-name">Saved Codes</span></div>
                        <div id="savedCodesList" class="file-list" style="padding-left: 20px; display: none;"></div>
                        <div class="tree-item" id="collaborationToggle" style="margin-top: 10px;"><i
                                class="fas fa-users" style="color: var(--accent-primary);"></i> <span
                                class="tree-item-name">Collaborators</span>
                        </div>
                    </div>
                </div>

                <!-- Chat Lists View -->
                <div id="chatsView" class="sidebar-view" style="display:none; flex-direction: column; height: 100%;">
                    <div class="sidebar-header"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="sidebar-title">CHATS</span>
                        <div class="header-actions">
                            <button id="addFriendBtn" title="Add Friend" class="icon-btn"><i
                                    class="fas fa-plus"></i></button>
                            <button id="makeCommunityBtn" title="New Community" class="icon-btn"><i
                                    class="fas fa-users"></i></button>
                        </div>
                    </div>
                    <div class="chat-search" style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                        <input type="text" id="chatSearchInput" placeholder="Search friends..."
                            style="width: 100%; padding: 5px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                    </div>
                    <div id="friendsList" class="friends-list" style="flex: 1; overflow-y: auto;">
                        <p class="no-friends" style="padding: 10px; color: var(--text-secondary);">No active chats</p>
                    </div>
                </div>

                <!-- Single Chat Conversation View (Hidden by default, slides in or replaces list) -->
                <div id="chatConversationView" class="sidebar-view"
                    style="display:none; flex-direction: column; height: 100%; background: var(--bg-secondary);">
                    <div class="sidebar-header"
                        style="display: flex; align-items: center; border-bottom: 1px solid var(--border-color);">
                        <button id="backToChatListBtn" title="Back" class="icon-btn" style="margin-right: 10px;"><i
                                class="fas fa-arrow-left"></i></button>
                        <div class="chat-header-info" style="display: flex; align-items: center; overflow: hidden;">
                            <img id="currentChatAvatar" src="" class="chat-avatar-small"
                                style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; display:none;">
                            <span id="currentChatName"
                                style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">User</span>
                        </div>
                    </div>
                    <div id="sidebarChatMessages" class="chat-messages"
                        style="flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px;">
                        <!-- Messages go here -->
                    </div>
                    <div class="chat-input-area"
                        style="padding: 10px; border-top: 1px solid var(--border-color); display: flex;">
                        <input type="text" id="sidebarChatInput" placeholder="Type a message..."
                            style="flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; padding: 6px;">
                        <button id="sidebarSendBtn" class="icon-btn" style="margin-left: 5px;"><i
                                class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            <div id="sidebarResizer" class="sidebar-resizer"></div>

            <!-- Editor Area -->
            <div class="editor-area editor-section">
                <div class="tabs-bar editor-toolbar" id="tabBar">
                    <button id="saveFolderBtn" class="tab" title="Save Folder"><i
                            class="fas fa-folder-plus"></i></button>
                    <div class="editor-tabs" id="editorTabs" style="display: flex; overflow-x: auto;"></div>
                    <button id="addTabBtn" class="tab" title="Add Tab"><i class="fas fa-plus"></i></button>
                    <div style="flex:1;"></div>
                    <div class="editor-toolbar-actions"
                        style="display:flex; align-items:center; gap:5px; padding-right:10px;">
                        <select id="languageSelect" class="select-modern"
                            style="padding:2px; font-size:11px; display:none;">
                            <option value="javascript">JS</option>
                            <option value="python">Py</option>
                            <option value="html">HTML</option>
                            <option value="css">CSS</option>
                            <option value="java">Java</option>
                            <option value="c">C</option>
                            <option value="cpp">C++</option>
                        </select>
                        <button id="saveCode" class="title-bar-btn"><i class="fas fa-save"></i><span id="saveText"
                                style="display:none;"></span></button>
                        <button id="shareCodeBtn" class="title-bar-btn"><i class="fas fa-share"></i></button>
                        <button id="livePreview" class="title-bar-btn" title="Live Preview (HTML)"><i
                                class="fas fa-eye"></i></button>


                        <div class="collaboration-status">
                            <button id="collaborateBtn" class="btn-success"
                                style="font-size:11px; padding:2px 6px;">Collab</button>
                            <div id="collaboratingLabel" class="collaborating-dropdown" style="display:none;">
                                <span id="sessionInfoBtn" class="collaborating-label">Collab</span>
                                <div id="sessionDropdown" class="session-dropdown">
                                    <div class="session-info">ID: <span id="dropdownRoomId"></span> Mode: <span
                                            id="dropdownMode"></span> Link: <input type="text" id="dropdownShareLink"
                                            readonly><button id="copyDropdownLink">Copy</button><button
                                            id="endSession">End</button><button id="exitSession">Exit</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Split Tab Bar Container -->
                <div class="split-tabbar-container" id="splitTabBarContainer">
                    <!-- Left: Editor Tabs (will resize with editor) -->
                    <div class="editor-tabbar-section" id="editorTabBarSection">
                        <!-- Breadcrumbs -->
                        <div id="breadcrumbsBar" class="breadcrumbs-bar">
                            <span class="breadcrumb-item"><i class="fas fa-folder"></i> CodeSynq</span>
                            <span class="breadcrumb-separator">â€º</span>
                            <span class="breadcrumb-item active" id="breadcrumbFileName">...</span>
                        </div>
                    </div>

                    <!-- Divider between tab bar sections (hidden when no preview) -->
                    <div class="tabbar-divider" id="tabBarDivider" style="display:none;"></div>

                    <!-- Right: Preview Tab (hidden when no preview) -->
                    <div class="preview-tabbar-section" id="previewTabBarSection" style="display:none;">
                        <div class="preview-tab active" id="previewTab">
                            <i class="fas fa-eye"></i>
                            <span>Preview</span>
                            <button class="tab-close-btn" id="closePreviewPaneBtn" title="Close Preview">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Split Editor Container -->
                <div class="split-editor-container" id="splitEditorContainer">
                    <!-- Left Pane: Editor + Terminal -->
                    <div class="editor-pane" id="editorPane">
                        <div class="editor-container" id="editor">
                            <div class="editor-watermark">CodeSynq</div>
                        </div>

                        <div class="resizer" id="resizer"></div>

                        <div class="terminal-panel visible output-section" id="terminalPanel">
                            <div class="terminal-header">
                                <div class="terminal-tabs">
                                    <button class="terminal-tab" data-tab="console">Console</button>
                                    <button class="terminal-tab active" data-tab="terminal">Terminal</button>
                                </div>
                                <div class="terminal-actions">
                                    <button id="openNewWindow" class="terminal-action"><i
                                            class="fas fa-external-link-alt"></i></button>
                                </div>
                            </div>
                            <div class="terminal-content" style="padding:0; position:relative;">
                                <div id="console" class="output-panel" style="display:none;"></div>
                                <div id="terminal" class="output-panel active"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Vertical Resizer for Split -->
                    <div class="split-resizer" id="splitResizer" style="display:none;"></div>

                    <!-- Right Pane: Preview Content Only (no tab bar) -->
                    <div class="preview-pane" id="previewPane" style="display:none;">
                        <div class="preview-pane-content">
                            <iframe id="previewFrame" class="preview-iframe"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel (Users/Chat) -->
            <div class="right-panel" id="rightPanel"
                style="display:none; width:250px; flex-direction:column; border-left:1px solid var(--border-primary); background:var(--bg-secondary);">
                <div class="panel-tabs" style="display:flex; border-bottom:1px solid var(--border-primary);">
                    <button class="panel-tab active" data-panel="users" style="flex:1;"><i
                            class="fas fa-users"></i></button>
                    <button class="panel-tab" data-panel="chat" style="flex:1;"><i class="fas fa-comments"></i></button>
                    <button class="panel-tab" data-panel="video" style="flex:1;"><i class="fas fa-video"></i></button>
                </div>
                <div id="users-panel" class="panel-content active" style="flex:1; overflow:auto;">
                    <div class="users-header">
                        <h3>Users (<span id="userCount">0</span>)</h3>
                        <div class="collaboration-controls"><button id="editModeBtn">Mode</button><span
                                id="currentEditor">Editing</span></div>
                    </div>
                    <div id="userList" class="users-list"></div>
                </div>
                <div id="chat-panel" class="panel-content" style="flex:1; display:none; flex-direction:column;">
                    <div class="chat-messages" id="chatMessages" style="flex:1; overflow:auto;"></div>
                    <div class="chat-input"><input type="text" id="chatInput"><button id="sendMessage">Send</button>
                    </div>
                </div>
                <div id="video-panel" class="panel-content" style="flex:1; display:none;">
                    <div class="video-grid" id="videoGrid"></div>
                    <div class="video-controls"><button id="toggleVideo">Video</button><button
                            id="toggleAudio">Mic</button><button id="flipCamera">Flip</button></div>
                </div>
            </div>

        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <div class="status-item"><i class="fas fa-code-branch"></i> main</div>
                <div class="status-item" id="aiStatus"><i class="fas fa-brain"></i> AI Ready</div>
                <div class="status-item" id="serverStatus"><i class="fas fa-server"></i> <span
                        id="serverStatusText">Offline</span></div>
            </div>
            <div class="status-right">
                <div class="status-item" id="cursorPos">Ln 1, Col 1</div>
                <div class="status-item">UTF-8</div>
                <div class="status-item">HTML</div>
            </div>
        </div>
    </div>





    <!-- Save Code Modal -->
    <div id="saveCodeModal" class="modal">
        <div class="modal-content">
            <h2>Save Code</h2>
            <div class="form-group">
                <label>File Name:</label>
                <input type="text" id="fileNameInput" placeholder="Enter file name..."
                    title="Enter a name for your file">
            </div>
            <div class="modal-actions">
                <button id="confirmSave" class="btn-primary" title="Save the code file">Save</button>
                <button id="cancelSave" class="btn-secondary" title="Cancel saving">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Saved Codes Modal -->
    <div id="savedCodesModal" class="modal">
        <div class="modal-content saved-codes-modal">
            <div class="modal-header">
                <button id="backToList" class="btn-icon" style="display: none;" title="Back to list"><i
                        class="fas fa-arrow-left"></i></button>
                <h2 id="savedCodesTitle">Saved Codes</h2>
            </div>
            <div id="savedCodesList" class="saved-codes-list"></div>
            <div id="codePreviewContent" class="code-preview" style="display: none;"></div>
            <div class="modal-actions">
                <button id="loadFolder" class="btn-primary" style="display: none;">Load Folder</button>
                <button id="loadCode" class="btn-primary" style="display: none;">Load Code</button>
                <button id="shareFolder" class="btn-secondary" style="display: none;">Share Folder</button>
                <button id="shareCode" class="btn-secondary" style="display: none;">Share Code</button>
                <button id="deleteFolder" class="btn-danger" style="display: none;">Delete Folder</button>
                <button id="deleteCode" class="btn-danger" style="display: none;">Delete</button>
                <button id="closeSavedCodes" class="btn-secondary" title="Close saved codes list">Close</button>
            </div>
        </div>
    </div>



    <!-- Language Switch Confirmation Modal -->
    <div id="languageSwitchModal" class="modal">
        <div class="modal-content">
            <h2>Switch Language</h2>
            <p>Are you sure? All current content will be lost.</p>
            <div class="modal-actions">
                <button id="saveBeforeSwitch" class="btn-primary" title="Save current code before switching language"><i
                        class="fas fa-save"></i> Save</button>
                <button id="trashAndSwitch" class="btn-danger" title="Discard current code and switch language"><i
                        class="fas fa-trash"></i> Trash</button>
                <button id="cancelSwitch" class="btn-secondary" title="Cancel language switch">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Username Modal -->
    <div id="usernameModal" class="modal">
        <div class="modal-content">
            <h2>Choose Your Username</h2>
            <p>Please enter a unique username to continue:</p>
            <div class="form-group">
                <input type="text" id="usernameInput" placeholder="Enter username..." maxlength="20">
                <div id="usernameStatus" class="username-status"></div>
            </div>
            <div class="modal-actions">
                <button id="confirmUsername" class="btn-primary" disabled>Continue</button>
            </div>
        </div>
    </div>

    <!-- Share Code Modal -->
    <div id="shareCodeModal" class="modal">
        <div class="modal-content">
            <h2>Share Code</h2>
            <p>Enter username to share your current code:</p>
            <div class="form-group">
                <input type="text" id="shareToInput" placeholder="Enter username...">
            </div>
            <div class="form-group">
                <label>Or select from friends:</label>
                <div id="shareCodeFriendsList" class="share-friends-list"></div>
            </div>
            <div class="share-via-link-wrapper">
                <span class="share-via-link-text">Share via Link</span>
                <button class="share-via-link-btn"
                    onclick="if(window.codeShareManager) { document.getElementById('shareCodeModal').style.display='none'; window.codeShareManager.openShareModal(); }"
                    title="Generate shareable link">
                    <i class="fas fa-link"></i>
                </button>
            </div>
            <div class="share-via-link-wrapper" style="border-top: none; padding-top: 10px; margin-top: 10px;">
                <span class="share-via-link-text">View Shared Codes</span>
                <button class="share-via-link-btn"
                    onclick="if(window.codeShareManager) { document.getElementById('shareCodeModal').style.display='none'; window.codeShareManager.openMySharesModal(); }"
                    title="View your shared codes">
                    <i class="fas fa-history"></i>
                </button>
            </div>
            <div class="share-via-link-wrapper" style="border-top: none; padding-top: 10px; margin-top: 10px;">
                <span class="share-via-link-text">Received Codes</span>
                <button class="share-via-link-btn"
                    onclick="if(window.codeShareManager) { document.getElementById('shareCodeModal').style.display='none'; window.codeShareManager.openReceivedModal(); }"
                    title="View codes shared with you">
                    <i class="fas fa-inbox"></i>
                </button>
            </div>
            <div class="modal-actions">
                <button id="confirmShare" class="btn-primary">Share Code</button>
                <button id="cancelShare" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Shared Code Preview Modal -->
    <div id="sharedCodePreviewModal" class="modal">
        <div class="modal-content code-preview-modal">
            <h2 id="sharedCodeTitle">Shared Code</h2>
            <div id="sharedCodePreview" class="code-preview"></div>
            <div class="modal-actions">
                <button id="loadSharedCode" class="btn-primary">Load Code</button>
                <button id="deleteSharedCode" class="btn-danger">Delete</button>
                <button id="saveSharedCode" class="btn-secondary">Save Code</button>
                <button id="closeSharedPreview" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Collaboration Modal -->
    <div id="collaborationModal" class="modal">
        <div class="modal-content">
            <h2>Start Collaboration Session</h2>
            <div class="form-group">
                <label>Room ID:</label>
                <input type="text" id="roomIdInput" readonly title="Unique room identifier">
                <button id="generateRoomId" class="btn-secondary" title="Generate new room ID">Generate New</button>
            </div>
            <div class="form-group">
                <label>Share Link:</label>
                <input type="text" id="shareLink" readonly title="Share this link with collaborators">
                <button id="copyLink" class="btn-secondary" title="Copy collaboration link">Copy Link</button>
            </div>
            <div class="form-group">
                <label>Collaboration Mode:</label>
                <select id="collaborationMode" title="Choose collaboration mode">
                    <option value="freestyle">Freestyle - All can edit</option>
                    <option value="restricted">Restricted - Request to edit</option>
                </select>
            </div>
            <div class="modal-actions">
                <button id="startCollaboration" class="btn-primary" title="Start collaboration session">Start
                    Session</button>
                <button id="cancelCollaboration" class="btn-secondary"
                    title="Cancel collaboration setup">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Hotjar Tracking Code for Fire-Nexus -->
    <script>
        (function (h, o, t, j, a, r) {
            h.hj = h.hj || function () { (h.hj.q = h.hj.q || []).push(arguments) };
            h._hjSettings = { hjid: 5300664, hjsv: 6 };
            a = o.getElementsByTagName('head')[0];
            r = o.createElement('script'); r.async = 1;
            r.src = t + h._hjSettings.hjid + j + h._hjSettings.hjsv;
            a.appendChild(r);
        })(window, document, 'https://static.hotjar.com/c/hotjar-', '.js?sv=');
    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>

    <!-- WebRTC -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <!-- App Scripts -->
    <script src="nexuscode.js"></script>
    <script src="shared_functions.js"></script>
    <script src="profile-picture.js"></script>
    <script src="toggler.js"></script>
    <script src="conalert.js"></script>
    <script src="nexusshare.js"></script>

    <!-- Local Execution Module -->
    <script src="local_execution/local-executor-client.js"></script>
    <script src="local_execution/execution-manager.js"></script>

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD-SfBy_r93JDZOrYM8YUaokyNDXolVUzI",
            authDomain: "codenexus-cbb96.firebaseapp.com",
            databaseURL: "https://codenexus-cbb96-default-rtdb.firebaseio.com",
            projectId: "codenexus-cbb96",
            storageBucket: "codenexus-cbb96.firebasestorage.app",
            messagingSenderId: "11546353758",
            appId: "1:11546353758:web:e280574d9e6d9d6c1fd4cf",
            measurementId: "G-NQMWQB4ZXK"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                checkUserUsername(user);
            } else {
                window.currentUser = null;
                updateUIForLoggedOutUser();
                clearCollaborationSession();
            }
        });

        // Check if user has username
        function checkUserUsername(user) {
            database.ref(`usernames/${user.uid}`).once('value', (snapshot) => {
                const username = snapshot.val();
                if (username) {
                    // User has username, proceed normally
                    window.currentUser = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        username: username,
                        photoURL: user.photoURL || `https://via.placeholder.com/40/007acc/ffffff?text=${(user.displayName || user.email).charAt(0).toUpperCase()}`
                    };

                    // Update user data in users collection (in case it's missing)
                    database.ref(`users/${user.uid}`).update({
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        username: username,
                        photoURL: user.photoURL || null,
                        lastLogin: firebase.database.ServerValue.TIMESTAMP
                    });

                    updateUIForLoggedInUser();
                    loadUserCode();
                    if (typeof loadProfilePicture === 'function') loadProfilePicture();
                    setTimeout(() => loadCollaborationSession(), 1000);
                } else {
                    // User needs to set username
                    showUsernameModal(user);
                }
            });
        }

        function updateUIForLoggedInUser() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('signupBtn').style.display = 'none';
            document.querySelector('.profile-dropdown').style.display = 'block';
            document.querySelector('.notifications-dropdown').style.display = 'block';
            document.querySelector('.friends-dropdown').style.display = 'block';
            document.getElementById('profileName').textContent = window.currentUser.displayName;
            document.getElementById('profileEmail').textContent = window.currentUser.email;
            document.getElementById('profileUsername').textContent = '@' + window.currentUser.username;

            // Update save button for logged in user
            const saveBtn = document.getElementById('saveCode');
            const saveText = document.getElementById('saveText');
            const savedCodesFolder = document.getElementById('savedCodesFolder');
            const shareBtn = document.getElementById('shareCodeBtn');

            if (saveBtn) {
                saveBtn.classList.remove('login-required');
                if (saveText) saveText.textContent = 'Save';
            }
            if (savedCodesFolder) {
                savedCodesFolder.style.display = 'flex';
            }
            // Refresh saved codes list in explorer
            if (typeof updateSavedCodesList === 'function') updateSavedCodesList();
            if (shareBtn) {
                shareBtn.style.display = 'flex';
            }

            loadSharedCodes();
            if (typeof loadProfilePicture === 'function') loadProfilePicture();
        }

        function updateUIForLoggedOutUser() {
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('signupBtn').style.display = 'block';
            document.querySelector('.profile-dropdown').style.display = 'none';
            document.querySelector('.notifications-dropdown').style.display = 'none';
            document.querySelector('.friends-dropdown').style.display = 'none';

            // Update save button for non-logged in user
            const saveBtn = document.getElementById('saveCode');
            const saveText = document.getElementById('saveText');
            const savedCodesFolder = document.getElementById('savedCodesFolder');
            const shareBtn = document.getElementById('shareCodeBtn');

            if (saveBtn) {
                saveBtn.classList.add('login-required');
                if (saveText) saveText.textContent = 'Login to Save';
            }
            if (savedCodesFolder) {
                savedCodesFolder.style.display = 'none';
                // Also hide the list
                const savedCodesList = document.getElementById('savedCodesList');
                if (savedCodesList) savedCodesList.style.display = 'none';
            }
            if (shareBtn) {
                shareBtn.style.display = 'none';
            }
        }

        window.signOut = function () {
            auth.signOut();
        };

        window.saveUserCode = function () {
            if (!window.currentUser) return;
            const code = window.editor ? window.editor.getValue() : '';
            const language = document.getElementById('languageSelect').value;

            database.ref(`users/${window.currentUser.uid}/code`).set({
                content: code,
                language: language,
                lastModified: firebase.database.ServerValue.TIMESTAMP
            });
        };

        function loadUserCode() {
            if (!window.currentUser || !window.editor) return;
            database.ref(`users/${window.currentUser.uid}/code`).once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && window.editor) {
                    const languageSelect = document.getElementById('languageSelect');

                    // Temporarily remove event listener
                    const oldHandler = languageSelect.onchange;
                    languageSelect.onchange = null;

                    languageSelect.dataset.previousValue = data.language;
                    languageSelect.value = data.language;

                    window.editor.setValue(data.content);

                    if (window.getCodeMirrorMode) {
                        const mode = window.getCodeMirrorMode(data.language);
                        window.editor.setOption('mode', mode);
                    }

                    // Restore event listener
                    setTimeout(() => { languageSelect.onchange = oldHandler; }, 100);
                }
            });
        }

        // Login/Signup handlers
        document.getElementById('loginBtn').onclick = () => {
            window.location.href = 'login.html';
        };

        document.getElementById('signupBtn').onclick = () => {
            window.location.href = 'signup.html';
        };

        // Username Modal Functions
        let usernameCheckTimeout;

        function showUsernameModal(user, isChange = false) {
            const modal = document.getElementById('usernameModal');
            const input = document.getElementById('usernameInput');
            const status = document.getElementById('usernameStatus');
            const confirmBtn = document.getElementById('confirmUsername');

            // Update modal title and button text for username change
            const modalTitle = modal.querySelector('h2');
            if (isChange) {
                modalTitle.textContent = 'Change Username';
                confirmBtn.textContent = 'Update Username';
                input.value = window.currentUser.username;
            } else {
                modalTitle.textContent = 'Choose Your Username';
                confirmBtn.textContent = 'Continue';
                input.value = '';
            }

            modal.style.display = 'block';
            input.focus();
            input.select();

            // Close modal when clicking outside
            modal.onclick = (e) => {
                if (e.target === modal && isChange) {
                    modal.style.display = 'none';
                }
            };

            input.oninput = () => {
                const username = input.value.trim().toLowerCase();
                input.value = username;
                clearTimeout(usernameCheckTimeout);

                if (username.length < 3) {
                    status.innerHTML = '<i class="fas fa-info-circle"></i> Username must be at least 3 characters';
                    status.className = 'username-status checking';
                    confirmBtn.disabled = true;
                    return;
                }

                if (!/^[a-z0-9_]+$/.test(username)) {
                    status.innerHTML = '<i class="fas fa-times-circle"></i> Only lowercase letters, numbers, and underscores allowed';
                    status.className = 'username-status unavailable';
                    confirmBtn.disabled = true;
                    return;
                }

                status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking availability...';
                status.className = 'username-status checking';
                confirmBtn.disabled = true;

                usernameCheckTimeout = setTimeout(() => {
                    checkUsernameAvailability(username, status, confirmBtn);
                }, 500);
            };

            confirmBtn.onclick = () => {
                const username = input.value.trim().toLowerCase();
                if (username && !confirmBtn.disabled) {
                    saveUsername(user, username);
                }
            };

            input.onkeypress = (e) => {
                if (e.key === 'Enter' && !confirmBtn.disabled) {
                    confirmBtn.click();
                }
            };
        }

        function checkUsernameAvailability(username, statusEl, confirmBtn) {
            database.ref('usernames').orderByValue().equalTo(username).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    statusEl.innerHTML = '<i class="fas fa-times-circle"></i> Username not available';
                    statusEl.className = 'username-status unavailable';
                    confirmBtn.disabled = true;
                } else {
                    statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Username available';
                    statusEl.className = 'username-status available';
                    confirmBtn.disabled = false;
                }
            });
        }

        function saveUsername(user, username) {
            const updates = {};
            const oldUsername = window.currentUser ? window.currentUser.username : null;

            updates[`usernames/${user.uid}`] = username;
            updates[`usernameToUid/${username}`] = user.uid;

            // Store user data in users collection for friend search
            updates[`users/${user.uid}`] = {
                email: user.email,
                displayName: user.displayName || user.email.split('@')[0],
                username: username,
                photoURL: user.photoURL || null,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            // Remove old username mapping if changing username
            if (oldUsername && oldUsername !== username) {
                updates[`usernameToUid/${oldUsername}`] = null;
            }

            database.ref().update(updates).then(() => {
                document.getElementById('usernameModal').style.display = 'none';

                // Update current user object
                if (window.currentUser) {
                    window.currentUser.username = username;
                    updateUIForLoggedInUser();
                } else {
                    // New user setup
                    window.currentUser = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        username: username,
                        photoURL: user.photoURL || `https://via.placeholder.com/40/007acc/ffffff?text=${(user.displayName || user.email).charAt(0).toUpperCase()}`
                    };
                    updateUIForLoggedInUser();
                    loadUserCode();
                    setTimeout(() => loadCollaborationSession(), 1000);
                }
            }).catch((error) => {
                alert('Error saving username: ' + error.message);
            });
        }

        // Change Username Button Handler
        document.getElementById('changeUsernameBtn').onclick = () => {
            showUsernameModal(auth.currentUser, true);
        };

        // Integrate notifications with existing dropdown system
        // This will be handled by the setupThemeAndSettings function in app.js

        // Share Code Functionality
        document.getElementById('shareCodeBtn').onclick = () => {
            document.getElementById('shareCodeModal').style.display = 'block';
            document.getElementById('shareToInput').focus();
            loadMainShareFriendsList();
        };

        document.getElementById('cancelShare').onclick = () => {
            document.getElementById('shareCodeModal').style.display = 'none';
        };

        document.getElementById('confirmShare').onclick = () => {
            const recipient = document.getElementById('shareToInput').value.trim();
            if (recipient) {
                shareCode(recipient);
            }
        };

        function shareCode(recipient) {
            const code = window.editor ? window.editor.getValue() : '';
            const language = document.getElementById('languageSelect').value;

            if (!code.trim()) {
                alert('No code to share!');
                return;
            }

            // Check if trying to share with self
            if (recipient === window.currentUser.username) {
                alert('You cannot share code with yourself!');
                return;
            }

            // Only allow username sharing (no email)
            if (recipient.includes('@')) {
                alert('Please enter a username, not an email address!');
                return;
            }

            shareToUsername(recipient, code, language);
        }

        function shareToUsername(username, code, language) {
            database.ref(`usernameToUid/${username}`).once('value', (snapshot) => {
                const recipientUid = snapshot.val();
                if (recipientUid) {
                    sendCodeShare(recipientUid, code, language);
                } else {
                    alert('Username not found!');
                }
            });
        }



        function sendCodeShare(recipientUid, code, language) {
            const shareData = {
                from: window.currentUser.username,
                fromUid: window.currentUser.uid,
                code: code,
                language: language,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            };

            database.ref(`sharedCodes/${recipientUid}`).push(shareData).then(() => {
                document.getElementById('shareCodeModal').style.display = 'none';
                const recipientUsername = document.getElementById('shareToInput').value.trim();
                document.getElementById('shareToInput').value = '';

                // Get recipient email for friend request
                database.ref(`usernameToUid/${recipientUsername}`).once('value', (snapshot) => {
                    const uid = snapshot.val();
                    if (uid) {
                        database.ref(`usernames/${uid}`).once('value', (userSnapshot) => {
                            // For now, we'll use username as email placeholder
                            // In a real app, you'd store email separately
                            showCodeShareSuccessModal(recipientUsername);
                        });
                    }
                });

                showNotification('Code shared successfully!');
            }).catch((error) => {
                showNotification('Error sharing code: ' + error.message, 'error');
            });
        }

        function loadSharedCodes() {
            if (!window.currentUser) return;

            database.ref(`sharedCodes/${window.currentUser.uid}`).on('value', (snapshot) => {
                const sharedCodes = snapshot.val() || {};
                updateNotifications(sharedCodes);
            });
        }

        function updateNotifications(sharedCodes) {
            const notificationBadge = document.getElementById('notificationBadge');
            const openInboxBtn = document.getElementById('openInboxBtn');
            const codes = Object.entries(sharedCodes);

            const unreadCount = codes.filter(([_, code]) => !code.read).length;
            notificationBadge.textContent = unreadCount;
            notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';

            if (openInboxBtn) {
                if (unreadCount > 0) {
                    openInboxBtn.innerHTML = `<i class="fas fa-envelope-open-text"></i> View Received Codes <span class="badge-pill">${unreadCount} new</span>`;
                } else {
                    openInboxBtn.innerHTML = `<i class="fas fa-envelope-open-text"></i> View Received Codes`;
                }
            }
        }

        let currentSharedCode = null;

        function viewSharedCode(id, sender, language, code) {
            // Mark as read
            database.ref(`sharedCodes/${window.currentUser.uid}/${id}/read`).set(true);

            // Store current shared code data
            currentSharedCode = { id, sender, language, code };

            // Show preview modal
            document.getElementById('sharedCodeTitle').textContent = `Code from @${sender} (${language})`;
            document.getElementById('sharedCodePreview').textContent = code;
            document.getElementById('sharedCodePreviewModal').style.display = 'block';

            // Close all dropdowns
            closeAllDropdowns();
        }

        let currentSharedFolder = null;

        function viewSharedFolder(id, folderData) {
            // Mark as read
            database.ref(`sharedCodes/${window.currentUser.uid}/${id}/read`).set(true);

            // Store current shared folder data
            currentSharedCode = { id, data: folderData, key: id };
            currentSharedFolder = folderData;

            // Show folder files list like saved codes
            document.getElementById('sharedCodeTitle').textContent = `${folderData.folderName} from @${folderData.from}`;

            const previewDiv = document.getElementById('sharedCodePreview');
            previewDiv.innerHTML = '';
            previewDiv.className = 'saved-codes-list';

            folderData.files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'saved-code-item';
                fileItem.innerHTML = `
                    <div class="saved-code-info">
                        <div class="saved-code-name">${file.name}</div>
                        <div class="saved-code-meta">
                            ${file.content.split('\n').length} lines
                        </div>
                    </div>
                    <div class="saved-code-language">${file.language}</div>
                `;

                fileItem.addEventListener('click', () => {
                    showSharedFilePreview(file, index);
                });

                previewDiv.appendChild(fileItem);
            });

            // Restore or reset scroll position for shared folder view
            setTimeout(() => {
                if (window.sharedFolderScrollPos !== undefined) {
                    previewDiv.scrollTop = window.sharedFolderScrollPos;
                } else {
                    previewDiv.scrollTop = 0;
                }
            }, 100);

            // Change Load Code button to Load Folder
            document.getElementById('loadSharedCode').textContent = 'Load Folder';
            document.getElementById('loadSharedCode').onclick = () => {
                loadSharedCodeToEditor();
            };

            document.getElementById('sharedCodePreviewModal').style.display = 'block';
            closeAllDropdowns();
        }

        function showSharedFilePreview(fileData, fileIndex) {
            // Save current scroll position before switching to file preview
            const previewDiv = document.getElementById('sharedCodePreview');
            if (previewDiv && previewDiv.className === 'saved-codes-list') {
                window.sharedFolderScrollPos = previewDiv.scrollTop;
            }

            document.getElementById('sharedCodeTitle').innerHTML = `<button onclick="viewSharedFolder('${currentSharedCode.id}', currentSharedFolder)" style="background: none; border: none; color: var(--text-primary); font-size: 1.2em; margin-right: 10px; cursor: pointer;"><i class="fas fa-arrow-left"></i></button>${fileData.name} from @${currentSharedFolder.from}`;

            previewDiv.className = 'code-preview';
            previewDiv.innerHTML = `
                <pre style="white-space: pre-wrap; font-family: 'Consolas', monospace; background: var(--bg-secondary); padding: 1rem; border-radius: 4px; overflow: auto; max-height: 300px;">${fileData.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
            `;

            // Reset scroll position for file preview
            setTimeout(() => {
                previewDiv.scrollTop = 0;
            }, 100);

            // Change button back to Load Code for individual file
            document.getElementById('loadSharedCode').textContent = 'Load Code';
            document.getElementById('loadSharedCode').onclick = () => {
                if (window.editor && monaco) {
                    const languageSelect = document.getElementById('languageSelect');
                    languageSelect.value = fileData.language;
                    const language = getMonacoLanguage(fileData.language);
                    monaco.editor.setModelLanguage(editor.getModel(), language);
                    editor.setValue(fileData.content);
                    updateLivePreviewVisibility(fileData.language);
                    document.getElementById('sharedCodePreviewModal').style.display = 'none';
                    showNotification(`Loaded ${fileData.name} from shared folder!`);
                }
            };
        }

        // Make functions globally accessible
        window.viewSharedCode = viewSharedCode;
        window.viewSharedFolder = viewSharedFolder;
        window.showSharedFilePreview = showSharedFilePreview;

        // Make showCodeShareSuccessModal globally accessible
        window.showCodeShareSuccessModal = showCodeShareSuccessModal;

        // Shared Code Modal Handlers
        document.getElementById('loadSharedCode').onclick = () => {
            if (currentSharedCode && window.editor) {
                if (currentSharedCode.data && currentSharedCode.data.folderName) {
                    // Load folder using the global function
                    loadSharedCodeToEditor();
                } else {
                    // Load single code
                    window.editor.setValue(currentSharedCode.code);
                    document.getElementById('languageSelect').value = currentSharedCode.language;
                    if (window.getCodeMirrorMode) {
                        const mode = window.getCodeMirrorMode(currentSharedCode.language);
                        window.editor.setOption('mode', mode);
                    }
                    document.getElementById('sharedCodePreviewModal').style.display = 'none';
                    alert(`Code from @${currentSharedCode.sender} loaded into editor!`);
                }
            }
        };

        document.getElementById('saveSharedCode').onclick = () => {
            if (currentSharedCode && window.currentUser) {
                if (currentSharedCode.data && currentSharedCode.data.folderName) {
                    // Save folder using the global function
                    saveSharedCodeToLibrary();
                } else {
                    // Save single code
                    const fileName = `shared_from_${currentSharedCode.sender}_${Date.now()}`;
                    const codeData = {
                        name: fileName,
                        content: currentSharedCode.code,
                        language: currentSharedCode.language,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        lastModified: new Date().toISOString()
                    };

                    database.ref(`users/${window.currentUser.uid}/savedCodes`).push(codeData).then(() => {
                        alert('Shared code saved successfully!');
                    }).catch((error) => {
                        alert('Error saving code: ' + error.message);
                    });
                }
            }
        };

        document.getElementById('deleteSharedCode').onclick = async () => {
            const itemType = (currentSharedCode.data && currentSharedCode.data.folderName) ? 'folder' : 'code';
            if (currentSharedCode && await customConfirm(`Are you sure you want to delete this shared ${itemType}?`)) {
                database.ref(`sharedCodes/${window.currentUser.uid}/${currentSharedCode.id}`).remove().then(() => {
                    document.getElementById('sharedCodePreviewModal').style.display = 'none';
                    alert(`Shared ${itemType} deleted successfully!`);
                }).catch((error) => {
                    alert(`Error deleting shared ${itemType}: ` + error.message);
                });
            }
        };

        document.getElementById('closeSharedPreview').onclick = () => {
            document.getElementById('sharedCodePreviewModal').style.display = 'none';
        };

        // Load friends list for main share code modal
        function loadMainShareFriendsList() {
            const friendsList = document.getElementById('shareCodeFriendsList');

            if (!window.currentUser) {
                friendsList.innerHTML = '<p class="no-friends">Login to see friends</p>';
                return;
            }

            friendsList.innerHTML = '<p class="loading-friends">Loading friends...</p>';

            database.ref(`friends/${window.currentUser.uid}`).once('value', (snapshot) => {
                const friends = snapshot.val();
                friendsList.innerHTML = '';

                if (!friends) {
                    friendsList.innerHTML = '<p class="no-friends">No friends to share with</p>';
                    return;
                }

                Object.entries(friends).forEach(([friendUid, friendData]) => {
                    const friendItem = document.createElement('div');
                    friendItem.className = 'share-friend-item';
                    friendItem.innerHTML = `
                        <div class="friend-avatar">${friendData.name.charAt(0).toUpperCase()}</div>
                        <div class="friend-name">${friendData.name}</div>
                    `;

                    friendItem.addEventListener('click', () => {
                        database.ref(`usernames/${friendUid}`).once('value', (usernameSnapshot) => {
                            const username = usernameSnapshot.val();
                            if (username) {
                                document.getElementById('shareToInput').value = username;
                            }
                        });
                    });

                    friendsList.appendChild(friendItem);
                });
            });
        }

        // Profile dropdown is now handled in setupThemeAndSettings
    </script>

    <!-- Add Friend Modal -->
    <div id="addFriendModal" class="modal">
        <div class="modal-content">
            <h2>Add Friend</h2>
            <div class="form-group">
                <label for="friendEmailInput">Username:</label>
                <input type="text" id="friendEmailInput" placeholder="Enter username">
                <div id="friendSearchStatus" class="friend-search-status"></div>
            </div>
            <div class="modal-actions">
                <button id="sendFriendRequest" class="btn-primary">Send Request</button>
                <button id="cancelAddFriend" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Friend Chat Modal -->
    <div id="friendChatModal" class="modal friend-chat-modal">
        <div class="modal-content friend-chat-content">
            <div class="chat-header">
                <div class="friend-info">
                    <img id="chatFriendAvatar" src="" alt="Friend" class="chat-friend-avatar">
                    <div>
                        <h3 id="chatFriendName">Friend Name</h3>
                        <span id="chatFriendStatus" class="friend-status">Online</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button id="pinFriendChat" class="btn-icon"><i class="fas fa-thumbtack"></i></button>
                    <button id="friendMenuBtn" class="btn-icon"><i class="fas fa-ellipsis-v"></i></button>
                    <button id="closeFriendChat" class="btn-icon"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="friendChatMessages" class="friend-chat-messages"></div>
            <div class="friend-chat-input">
                <input type="text" id="friendMessageInput" placeholder="Type a message...">
                <button id="sendFriendMessage" class="btn-primary"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Code Share Success Modal -->
    <div id="codeShareSuccessModal" class="modal">
        <div class="modal-content">
            <h2>Code Shared Successfully!</h2>
            <p>Your code has been sent. Would you like to add this user to your friends list?</p>
            <div class="form-group">
                <label>Recipient:</label>
                <span id="shareRecipientUsername"></span>
            </div>
            <div class="modal-actions">
                <button id="addRecipientAsFriend" class="btn-primary">Add as Friend</button>
                <button id="skipAddFriend" class="btn-secondary">Skip</button>
            </div>
        </div>
    </div>

    <div id="dropdownBlurOverlay" class="dropdown-blur-overlay"></div>

    <!-- Make Community Modal -->
    <div id="makeCommunityModal" class="modal">
        <div class="modal-content">
            <h2>Create Community</h2>
            <div class="form-group">
                <label for="communityNameInput">Community Name (emojis allowed):</label>
                <input type="text" id="communityNameInput" placeholder="Enter community name... ðŸš€">
            </div>
            <div class="form-group">
                <label>Select Friends:</label>
                <div id="friendsSelectionList" class="friends-selection-list">
                    <p class="no-friends">Loading friends...</p>
                </div>
            </div>
            <div class="modal-actions">
                <button id="createCommunity" class="btn-primary">Create Community</button>
                <button id="cancelCommunity" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Community Chat Modal -->
    <div id="communityChatModal" class="modal community-chat-modal">
        <div class="modal-content community-chat-content">
            <div class="chat-header">
                <div class="community-info">
                    <h3 id="communityName">Community Name</h3>
                    <span id="communityMemberCount" class="community-member-count">0 members</span>
                </div>
                <div class="header-actions">
                    <button id="pinCommunityChat" class="btn-icon"><i class="fas fa-thumbtack"></i></button>
                    <button id="communityMenuBtn" class="btn-icon"><i class="fas fa-ellipsis-v"></i></button>
                    <button id="closeCommunityChat" class="btn-icon"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="communityChatMessages" class="community-chat-messages"></div>
            <div class="community-chat-input">
                <div id="adminOnlyLabel" class="admin-only-label" style="display: none;">Only admins can message</div>
                <input type="text" id="communityMessageInput" placeholder="Type a message...">
                <button id="sendCommunityMessage" class="btn-primary"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    <!-- Community Settings Modal -->
    <div id="communitySettingsModal" class="modal">
        <div class="modal-content">
            <h2 id="communitySettingsTitle">Community Settings</h2>

            <!-- Security Settings -->
            <div class="community-security-settings">
                <h3>Security Settings</h3>
                <div class="setting-item">
                    <label>Who can message:</label>
                    <select id="messagingPermission">
                        <option value="everyone">Everyone</option>
                        <option value="admins">Admins Only</option>
                    </select>
                </div>
            </div>

            <div id="communityMembersList" class="community-members-list"></div>
            <div class="modal-actions">
                <button id="leaveCommunity" class="btn-danger">Leave Community</button>
                <button id="deleteCommunity" class="btn-danger" style="display: none;">Delete Community</button>
                <button id="closeCommunitySettings" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Member Actions Dropdown -->
    <div id="memberActionsDropdown" class="member-actions-dropdown" style="display: none;">
        <div class="dropdown-item" onclick="makeAdmin()">Make Admin</div>
        <div class="dropdown-item" onclick="removeMember()">Remove Member</div>
    </div>

    <!-- Friend Info Modal -->
    <div id="friendInfoModal" class="modal">
        <div class="modal-content">
            <h2>Friend Information</h2>
            <div class="friend-info-details">
                <div class="info-item">
                    <label>Name:</label>
                    <span id="friendInfoName"></span>
                </div>
                <div class="info-item">
                    <label>Email:</label>
                    <span id="friendInfoEmail"></span>
                </div>
                <div class="info-item">
                    <label>Username:</label>
                    <span id="friendInfoUsername"></span>
                </div>
            </div>
            <div class="modal-actions">
                <button id="removeFriend" class="btn-danger">Remove Friend</button>
                <button id="closeFriendInfo" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Pinned Chat Widget -->
    <div id="pinnedChatWidget" class="pinned-chat-widget" style="display: none;">
        <div class="pinned-chat-avatar"></div>
        <div class="pinned-chat-name"></div>
    </div>

    <!-- Save Folder Modal -->
    <div id="saveFolderModal" class="modal">
        <div class="modal-content">
            <h2>Save as Folder</h2>
            <div class="form-group">
                <label>Folder Name:</label>
                <input type="text" id="folderNameInput" placeholder="Enter folder name...">
            </div>
            <div class="modal-actions">
                <button id="confirmSaveFolder" class="btn-primary">Save Folder</button>
                <button id="cancelSaveFolder" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Custom Popup Modal -->
    <div id="customPopupModal" class="modal">
        <div class="modal-content">
            <h2 id="popupTitle">Confirm</h2>
            <p id="popupMessage">Are you sure?</p>
            <div class="modal-actions">
                <button id="popupConfirm" class="btn-primary">OK</button>
                <button id="popupCancel" class="btn-secondary" style="display: none;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Share Input Modal -->
    <div id="shareInputModal" class="modal">
        <div class="modal-content">
            <h2 id="shareInputTitle">Share</h2>
            <div class="form-group">
                <label id="shareInputLabel">Enter username:</label>
                <input type="text" id="shareInputField" placeholder="Username...">
            </div>
            <div class="form-group">
                <label>Or select from friends:</label>
                <div id="shareFriendsList" class="share-friends-list"></div>
            </div>
            <div class="modal-actions">
                <button id="shareInputConfirm" class="btn-primary">Share</button>
                <button id="shareInputCancel" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>



    <!--   ai mod section -->
    <!-- Drawer Open Button -->
    <button id="drawerOpenBtn" class="mobile-open-btn"><i class="fas fa-brain"></i></button>

    <!-- Right Drawer Panel -->
    <div id="drawerPanel" class="mobile-drawer-panel">

        <div class="drawer-header">
            <div class="model-select-box">
                <select id="modelSelector">
                    <option value="google">Google</option>
                    <option value="blackbox">Blackbox AI</option>
                </select>
            </div>

            <button id="drawerCloseBtn" class="close-btn"><i class="fas fa-times"></i></button>
        </div>

        <!-- Drag Resize Handle -->
        <div id="drawerResize" class="drawer-resize"></div>
        <div id="drawerOverlay" class="drawer-overlay"></div>


        <div class="drawer-content">
            <iframe id="drawerIframe" frameborder="0"></iframe>
        </div>


    </div>

    </div>

    <!-- Refined New File Modal (VS Code Style V3 - Perfect Alignment) -->
    <div id="newFileModalRefinedV3" class="modal"
        style="display: none; position: fixed; z-index: 20000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); align-items: flex-start; justify-content: center; padding-top: 100px;">
        <div class="modal-content"
            style="background-color: #252526; margin: 0 auto; padding: 0; border: 1px solid #454545; width: 100%; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); border-radius: 4px;">
            <div
                style="background-color: #252526; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333;">
                <span
                    style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: #cccccc; font-family: 'Segoe UI', sans-serif;">Create
                    New File</span>
                <div onclick="document.getElementById('newFileModalRefinedV3').style.display='none'"
                    style="color: #cccccc; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 4px; transition: background 0.1s;">
                    <i class="fas fa-times" style="font-size: 14px;"></i>
                </div>
            </div>

            <div style="padding: 20px 20px 24px;">
                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; margin-bottom: 8px; font-size: 13px; color: #cccccc; font-family: 'Segoe UI', sans-serif;">File
                        name</label>
                    <div style="display: flex; height: 30px; position: relative;">
                        <input type="text" id="newFileNameInputRefinedV3" placeholder="filename"
                            style="flex: 1; min-width: 0; height: 30px; box-sizing: border-box; background-color: #3c3c3c; color: #cccccc; border: 1px solid #3c3c3c; border-right: none; padding: 0 8px; font-family: 'Consolas', monospace; font-size: 13px; outline: none; border-radius: 2px 0 0 2px; line-height: 28px; margin-top: 0;">

                        <div style="position: relative; width: 80px; height: 30px;">
                            <select id="newFileExtensionSelectRefinedV3"
                                style="width: 100%; height: 100%; box-sizing: border-box; background-color: #3c3c3c; color: #cccccc; border: 1px solid #3c3c3c; border-left: 1px solid #454545; padding: 0 4px; font-size: 13px; outline: none; border-radius: 0 2px 2px 0; cursor: pointer; appearance: none; -webkit-appearance: none;">
                                <option value=".js" selected>.js</option>
                                <option value=".py">.py</option>
                                <option value=".html">.html</option>
                                <option value=".css">.css</option>
                                <option value=".java">.java</option>
                                <option value=".c">.c</option>
                                <option value=".cpp">.cpp</option>
                                <option value=".json">.json</option>
                                <option value=".md">.md</option>
                            </select>
                            <i class="fas fa-chevron-down"
                                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #cccccc; pointer-events: none;"></i>
                        </div>
                    </div>
                    <style>
                        #newFileNameInputRefinedV3:focus {
                            border-color: #007fd4 !important;
                            z-index: 2;
                        }

                        #newFileExtensionSelectRefinedV3:focus {
                            border-color: #007fd4 !important;
                            z-index: 2;
                        }
                    </style>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button id="saveLocallyBtnRefinedV3"
                        style="flex: 1; background-color: #0e639c; color: white; border: none; padding: 0; height: 30px; font-size: 13px; cursor: pointer; border-radius: 2px; font-family: 'Segoe UI', sans-serif;">Save
                        Locally</button>
                    <button id="saveSynqCloudBtnRefinedV3"
                        style="flex: 1; background-color: #3c3c3c; color: white; border: none; padding: 0; height: 30px; font-size: 13px; cursor: pointer; border-radius: 2px; font-family: 'Segoe UI', sans-serif;">Save
                        to Cloud</button>
                </div>
            </div>
        </div>
    </div>





    <!-- Refined New File Modal (VS Code Style V3 - Perfect Alignment) -->
    <div id="newFileModalRefinedV3" class="modal"
        style="display: none; position: fixed; z-index: 20000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); align-items: flex-start; justify-content: center; padding-top: 100px;">
        <div class="modal-content"
            style="background-color: #252526; margin: 0 auto; padding: 0; border: 1px solid #454545; width: 100%; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); border-radius: 4px;">
            <div
                style="background-color: #252526; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333;">
                <span
                    style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: #cccccc; font-family: 'Segoe UI', sans-serif;">Create
                    New File</span>
                <div onclick="document.getElementById('newFileModalRefinedV3').style.display='none'"
                    style="color: #cccccc; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 4px; transition: background 0.1s;">
                    <i class="fas fa-times" style="font-size: 14px;"></i>
                </div>
            </div>

            <div style="padding: 20px 20px 24px;">
                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; margin-bottom: 8px; font-size: 13px; color: #cccccc; font-family: 'Segoe UI', sans-serif;">File
                        name</label>
                    <div style="display: flex; height: 30px; position: relative;">
                        <input type="text" id="newFileNameInputRefinedV3" placeholder="filename"
                            style="flex: 1; min-width: 0; height: 30px; box-sizing: border-box; background-color: #3c3c3c; color: #cccccc; border: 1px solid #3c3c3c; border-right: none; padding: 0 8px; font-family: 'Consolas', monospace; font-size: 13px; outline: none; border-radius: 2px 0 0 2px; line-height: 28px;">

                        <div style="position: relative; width: 80px; height: 30px;">
                            <select id="newFileExtensionSelectRefinedV3"
                                style="width: 100%; height: 100%; box-sizing: border-box; background-color: #3c3c3c; color: #cccccc; border: 1px solid #3c3c3c; border-left: 1px solid #454545; padding: 0 4px; font-size: 13px; outline: none; border-radius: 0 2px 2px 0; cursor: pointer; appearance: none; -webkit-appearance: none;">
                                <option value=".js" selected>.js</option>
                                <option value=".py">.py</option>
                                <option value=".html">.html</option>
                                <option value=".css">.css</option>
                                <option value=".java">.java</option>
                                <option value=".c">.c</option>
                                <option value=".cpp">.cpp</option>
                            </select>
                            <i class="fas fa-chevron-down"
                                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #cccccc; pointer-events: none;"></i>
                        </div>
                    </div>
                    <style>
                        #newFileNameInputRefinedV3:focus {
                            border-color: #007fd4 !important;
                            z-index: 2;
                        }

                        #newFileExtensionSelectRefinedV3:focus {
                            border-color: #007fd4 !important;
                            z-index: 2;
                        }
                    </style>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button id="saveLocallyBtnRefinedV3"
                        style="flex: 1; background-color: #0e639c; color: white; border: none; padding: 0; height: 30px; font-size: 13px; cursor: pointer; border-radius: 2px; font-family: 'Segoe UI', sans-serif;">Save
                        Locally</button>
                    <button id="saveSynqCloudBtnRefinedV3"
                        style="flex: 1; background-color: #3c3c3c; color: white; border: none; padding: 0; height: 30px; font-size: 13px; cursor: pointer; border-radius: 2px; font-family: 'Segoe UI', sans-serif;">Save
                        to Cloud</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Explorer Context Menu -->
    <div id="explorerContextMenu" class="explorer-context-menu" style="display: none;">
        <!-- Menu items will be dynamically added -->
    </div>

    <style>
        .icon-btn-small {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
        }

        .workspace-header:hover .icon-btn-small,
        .icon-btn-small:focus {
            opacity: 1;
        }

        .icon-btn-small:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .file-menu-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 12px;
        }

        .tree-item:hover .file-menu-btn,
        .file-item:hover .file-menu-btn {
            opacity: 1;
        }

        .file-menu-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .explorer-context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            min-width: 150px;
            padding: 4px 0;
        }

        .context-menu-item {
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .context-menu-item:hover {
            background: var(--accent-color);
        }

        .context-menu-item i {
            width: 16px;
            text-align: center;
            font-size: 12px;
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        .context-menu-item.danger {
            color: #f44336;
        }

        .context-menu-item.danger:hover {
            background: rgba(244, 67, 54, 0.2);
        }
    </style>
    <!-- Quick Open Modal -->
    <div id="quickOpenModal" class="quick-open-modal" style="display: none;">
        <div class="quick-open-content">
            <input type="text" id="quickOpenInput" placeholder="Search files (Ctrl+P)">
            <div id="quickOpenList" class="quick-open-list"></div>
        </div>
    </div>
    <script src="quickopen.js"></script>
</body>

</html>